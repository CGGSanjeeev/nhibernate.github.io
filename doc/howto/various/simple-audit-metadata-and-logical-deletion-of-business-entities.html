---
layout: doc
title: Simple audit metadata and logical deletion of business entities
---
                <div id="CommonNavigationShadow">
                    
    
    <div class="CommonBreadCrumbArea"><div class="Common">
        <a href="../index.html">Documentation</a>
        »
        <a href="simple-audit-metadata-and-logical-deletion-of-business-entities.html">Simple audit metadata and logical deletion of business entities</a>
    </div></div>


                </div>
		    
                        
            <div class="Common">
            
                
            
                
                <div id="CommonTitle">
                    
    
    <h1>How to</h1>


                </div>
                <div style="clear: both;"></div>
			    <div id="CommonSidebarLeft">
			        
    
	<div class="CommonSidebar">
	    
	                <div class="CommonContentBox">
                        <h4 class="CommonContentBoxHeader">Page Details</h4>
	                    <div class="CommonContentBoxContent">
	            <div class="CustomWikiPageDetailsArea">
<div class="CustomWikiPageDetailsTitle">First published by:</div>
<div class="CustomWikiPageDetailsAvatar"><img src="../../utility/anonymous.gif" alt="" style="border-width:0px;max-height:50px;max-width:50px;"></div>
<div class="CustomWikiPageDetailsContent">
<a href="../../members/rcarlomagno/default.aspx.html">Raul Carlomagno</a><br> on 06-20-2009</div>
</div>
<div class="CustomWikiPageDetailsArea">
<div class="CustomWikiPageDetailsTitle">Last revision by:</div>
<div class="CustomWikiPageDetailsAvatar"><img src="../../utility/anonymous.gif" alt="" style="border-width:0px;max-height:50px;max-width:50px;"></div>
<div class="CustomWikiPageDetailsContent">
<a href="../../members/rcarlomagno/default.aspx.html">Raul Carlomagno</a><br> on 06-20-2009</div>
</div>
				        </div>
<div>
			This page is converted from the old nhforge.org Wiki.
		</div>
				        
			        </div>
	            
	    
	    
	    
    </div>
    

			    </div>
                
			    <div id="CommonContent"><div id="CommonContentInner">
    



<div class="CommonContentBox">
    <div class="CommonContentBoxContent">
        <div style="float: right">
            
        </div>
        
        

        
            <div class="CommonGroupedContentArea">                

                

                <h2 class="">
                        <span><a href="simple-audit-metadata-and-logical-deletion-of-business-entities.html">Simple audit metadata and logical deletion of business entities</a></span>
                        
                    </h2>
                                
                
                <div>
<p>This article is just about a simple way to achieve auditing and perform logical delete of your sensible data, doing use of the listeners features of NHibernate. Design patterns and architecture principles are outside of the scope of the article, this is just an example, take it as a guide.</p>
<p>Remember the old days when you had to audit data stored on your database, every time you build a query to insert, update or delete data, you had to “remember” to include the values for auditing (timestamp, user id). It was worse if you had stored procedures (by the way, i hate them) because suppose that was needed to take user credentials from another service to audit, you were limited by Transact-SQL language inside the stored procedure to access that service. Anyway, every time you build a query, you need those metadata values to store them, it could be good if you can centralize the place where you obtain and set those values (remember DRY).</p>
<p>Maybe, in a strict way, auditing would take place in the business layer, but we are not going to miss this feature that NHibernate has for us, so auditing will take place in the data access layer. With NHibernate we can override its native methods when performing data access, NHibernate will fire events which we will have to override to audit the data and of course to do a logical deletion of our entities.</p>
<p>Let’s get inside the code and explain the domain. In the example we have a BaseEntity for any persistible entity, and then, for the auditable entities, the AuditableEntity which inherits from BaseEntity. We want to audit the cars inside the database. We will audit the date and time, the user, the IP address and the hostname for each action on the entity (insert, update, delete), i think this auditing metada is fine, you can add more of course, your fantasy is your limit.</p>
<p>In fact this can’t be called audit, because we are not tracking changes of entities, just who did an action, when and from, pseudoaudit? [:D]</p>
<p><img title="image" style="display:inline;border-width:0px;border:0;" alt="image" src="simple-audit-metadata-and-logical-deletion-of-business-entities.png" width="407" border="0" height="712"> </p>
<p>So, the example solution has a test fixture to test the purpose of the example. It was developed with NHibernate 2.1.0.2001.</p>
<p>No more words, show me the code.</p>
<p>Let’s see the mapping files.</p>
<h4><b>Car.hbm.xml</b></h4>
<p> </p>
<div class="wlWriterEditableSmartContent" id="scid:57F11A72-B0E5-49c7-9094-E3A15BD5B5E6:411b4d59-2c28-4172-ab11-be3aabfc1650" style="padding-right:0px;display:inline;padding-left:0px;float:none;padding-bottom:0px;margin:0px;padding-top:0px;">
<pre style="background-color:#FFFFFF;overflow:auto;"><span style="color:#0000FF;">&lt;?</span><span style="color:#FF00FF;">xml version="1.0" encoding="utf-8" </span><span style="color:#0000FF;">?&gt;</span><span style="color:#000000;"><br></span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">hibernate-mapping </span><span style="color:#FF0000;">xmlns</span><span style="color:#0000FF;">="urn:nhibernate-mapping-2.2"</span><span style="color:#FF0000;"><br>                   assembly</span><span style="color:#0000FF;">="AuditExample"</span><span style="color:#FF0000;"><br>                   namespace</span><span style="color:#0000FF;">="AuditExample.Entities"</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;"><br>  <br>  </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">class </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="Car"</span><span style="color:#FF0000;"> table</span><span style="color:#0000FF;">="cars"</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">id </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="Id"</span><span style="color:#FF0000;"> type</span><span style="color:#0000FF;">="Int64"</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;"><br>      </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">generator </span><span style="color:#FF0000;">class</span><span style="color:#0000FF;">="hilo"</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;"><br>        </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">param </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="max_lo"</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">50</span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">param</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;"><br>      </span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">generator</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">id</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;"><br><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="BrandName"</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= "brand_name"</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="ModelName"</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= "model_name"</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="Kilometers"</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= "kilometers"</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;"><br>      <br>    </span><span style="color:#008000;">&lt;!--</span><span style="color:#008000;">audit attributes</span><span style="color:#008000;">--&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">many-to-one </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="AddedBy"</span><span style="color:#FF0000;"> class</span><span style="color:#0000FF;">="AuditExample.Entities.User, AuditExample"</span><span style="color:#FF0000;"><br>        column</span><span style="color:#0000FF;">="added_user_id"</span><span style="color:#FF0000;"> not-null</span><span style="color:#0000FF;">="false"</span><span style="color:#FF0000;"> </span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="AddedDate"</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= "added_date"</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="AddedFromIP"</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= "added_from_ip"</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="AddedFromHostName"</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= "added_from_hostname"</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;"><br>    <br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">many-to-one </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="ModifiedBy"</span><span style="color:#FF0000;"> class</span><span style="color:#0000FF;">="AuditExample.Entities.User, AuditExample"</span><span style="color:#FF0000;"><br>        column</span><span style="color:#0000FF;">="modified_user_id"</span><span style="color:#FF0000;"> not-null</span><span style="color:#0000FF;">="false"</span><span style="color:#FF0000;"> </span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="ModifiedDate"</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= "modified_date"</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="ModifiedFromIP"</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= "modified_from_ip"</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="ModifiedFromHostName"</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= "modified_from_hostname"</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">    <br>    <br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">many-to-one </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="ErasedBy"</span><span style="color:#FF0000;"> class</span><span style="color:#0000FF;">="AuditExample.Entities.User, AuditExample"</span><span style="color:#FF0000;"><br>        column</span><span style="color:#0000FF;">="erased_user_id"</span><span style="color:#FF0000;"> not-null</span><span style="color:#0000FF;">="false"</span><span style="color:#FF0000;"> </span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="ErasedDate"</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= "erased_date"</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="ErasedFromIP"</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= "erased_from_ip"</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="ErasedFromHostName"</span><span style="color:#FF0000;"> column </span><span style="color:#0000FF;">= "erased_from_hostname"</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;"><br><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">filter </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="avoidLogicalDeleted"</span><span style="color:#FF0000;"> condition</span><span style="color:#0000FF;">="erased_date IS NULL"</span><span style="color:#FF0000;"> </span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;"><br>    <br>  </span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">class</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;"><br>  <br>  </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">filter-def </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="avoidLogicalDeleted"</span><span style="color:#FF0000;"> </span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;"><br>  <br></span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">hibernate-mapping</span><span style="color:#0000FF;">&gt;</span></pre>
&lt;!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --&gt;</div>
<p>It has the Id, 3 owned properties, and 9 properties for metadata auditing. The filter part is about logical deletes, we are going to talk about it in later. </p>
<p>The <b>User.hbm.xml </b>is really simple, we are not going to show it, it has no sense, anyway, the example solution can be downloaded.</p>
<p>Now it’s time to show the NHibernate configuration file.</p>
<h4><b>hibernate.cfg.xml</b></h4>
<div class="wlWriterEditableSmartContent" id="scid:57F11A72-B0E5-49c7-9094-E3A15BD5B5E6:3ba95b40-497a-4b28-8b49-14fc1742bf02" style="padding-right:0px;display:inline;padding-left:0px;float:none;padding-bottom:0px;margin:0px;padding-top:0px;">
<pre style="background-color:#FFFFFF;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;white-space:pre-wrap;word-wrap:break-word;overflow:auto;"><span style="color:#0000FF;">&lt;?</span><span style="color:#FF00FF;">xml version="1.0" encoding="utf-8"</span><span style="color:#0000FF;">?&gt;</span><span style="color:#000000;"><br></span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">hibernate-configuration  </span><span style="color:#FF0000;">xmlns</span><span style="color:#0000FF;">="urn:nhibernate-configuration-2.2"</span><span style="color:#FF0000;"> </span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;"><br>  </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">session-factory</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="connection.driver_class"</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">NHibernate.Driver.SqlClientDriver</span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">property</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="connection.connection_string"</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;"><br>      Server=(local)\SQLEXPRESS;initial catalog=auditexample;Integrated Security=SSPI<br>    </span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">property</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="adonet.batch_size"</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">10</span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">property</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="show_sql"</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">false</span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">property</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="dialect"</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">NHibernate.Dialect.MsSql2005Dialect</span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">property</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="query.substitutions"</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;">true 1, false 0, yes 'Y', no 'N'</span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">property</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">property </span><span style="color:#FF0000;">name</span><span style="color:#0000FF;">="proxyfactory.factory_class"</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;"><br>        NHibernate.ByteCode.Castle.ProxyFactoryFactory, NHibernate.ByteCode.Castle<br>    </span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">property</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">mapping </span><span style="color:#FF0000;">assembly</span><span style="color:#0000FF;">="AuditExample"</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">listener </span><span style="color:#FF0000;">class</span><span style="color:#0000FF;">="AuditExample.NHExtensions.CustomSaveUpdateEventListener, AuditExample"</span><span style="color:#FF0000;"><br>        type</span><span style="color:#0000FF;">="save-update"</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;"><br>    </span><span style="color:#0000FF;">&lt;</span><span style="color:#800000;">listener </span><span style="color:#FF0000;">class</span><span style="color:#0000FF;">="AuditExample.NHExtensions.CustomDeleteEventListener, AuditExample"</span><span style="color:#FF0000;"><br>        type</span><span style="color:#0000FF;">="delete"</span><span style="color:#0000FF;">/&gt;</span><span style="color:#000000;">    <br>  </span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">session-factory</span><span style="color:#0000FF;">&gt;</span><span style="color:#000000;"><br></span><span style="color:#0000FF;">&lt;/</span><span style="color:#800000;">hibernate-configuration</span><span style="color:#0000FF;">&gt;</span></pre>
&lt;!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --&gt;</div>
<p>Let’s analyze it, in the configuration file there is an attribute that is not so common, the listener attribute, as we mention before, with these attributes we are forcing NHibernate to lookup for the custom event listener that we inherited from the default listeners for ISession.Delete() and ISession.SaveUpdate() methods. Inside both class CustomSaveUpdateEventListener and CustomDeleteEventListener will appear a class called SecurityContext which handles the metada for auditing, this class will be discused later, after explaining both listeners.</p>
<h4><b>CustomSaveUpdateEventListener.cs</b></h4>
<div class="wlWriterEditableSmartContent" id="scid:57F11A72-B0E5-49c7-9094-E3A15BD5B5E6:e2d0d747-e26f-4d1c-a83b-59a459662651" style="padding-right:0px;display:inline;padding-left:0px;float:none;padding-bottom:0px;margin:0px;padding-top:0px;">
<pre style="background-color:#FFFFFF;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;white-space:pre-wrap;word-wrap:break-word;overflow:auto;"><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">class</span><span style="color:#000000;"> CustomSaveUpdateEventListener : DefaultSaveOrUpdateEventListener<br>{<br>   </span><span style="color:#0000FF;">protected</span><span style="color:#000000;"> </span><span style="color:#0000FF;">override</span><span style="color:#000000;"> </span><span style="color:#0000FF;">object</span><span style="color:#000000;"> PerformSaveOrUpdate(SaveOrUpdateEvent evt)<br>   {<br>       var entity </span><span style="color:#000000;">=</span><span style="color:#000000;"> evt.Entity </span><span style="color:#0000FF;">as</span><span style="color:#000000;"> AuditableEntity;<br><br>          </span><span style="color:#0000FF;">if</span><span style="color:#000000;"> (entity </span><span style="color:#000000;">!=</span><span style="color:#000000;"> </span><span style="color:#0000FF;">null</span><span style="color:#000000;">){<br>              </span><span style="color:#0000FF;">if</span><span style="color:#000000;"> (entity.Id </span><span style="color:#000000;">==</span><span style="color:#000000;"> </span><span style="color:#800080;">0</span><span style="color:#000000;">)<br>                  ProcessEntityForInserting(entity);<br>              </span><span style="color:#0000FF;">else</span><span style="color:#000000;"><br>                  ProcessEntityForUpdating(entity);<br>          }<br>       <br>          </span><span style="color:#0000FF;">return</span><span style="color:#000000;"> </span><span style="color:#0000FF;">base</span><span style="color:#000000;">.PerformSaveOrUpdate(evt);<br>   }<br><br>   </span><span style="color:#0000FF;">internal</span><span style="color:#000000;"> </span><span style="color:#0000FF;">virtual</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> ProcessEntityForInserting(AuditableEntity entity)<br>    {<br>       entity.AddedDate </span><span style="color:#000000;">=</span><span style="color:#000000;"> DateTime.Now;<br>       entity.AddedBy </span><span style="color:#000000;">=</span><span style="color:#000000;"> SecurityContext.LoggedUser </span><span style="color:#000000;">??</span><span style="color:#000000;"> </span><span style="color:#0000FF;">null</span><span style="color:#000000;">;<br>       entity.AddedFromIP </span><span style="color:#000000;">=</span><span style="color:#000000;"> SecurityContext.GetHostIP();<br>       entity.AddedFromHostName </span><span style="color:#000000;">=</span><span style="color:#000000;"> SecurityContext.GetHostName();<br>    }<br><br>   </span><span style="color:#0000FF;">internal</span><span style="color:#000000;"> </span><span style="color:#0000FF;">virtual</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> ProcessEntityForUpdating(AuditableEntity entity)<br>    {<br>       entity.ModifiedDate </span><span style="color:#000000;">=</span><span style="color:#000000;"> DateTime.Now;<br>       entity.ModifiedBy </span><span style="color:#000000;">=</span><span style="color:#000000;"> SecurityContext.LoggedUser </span><span style="color:#000000;">??</span><span style="color:#000000;"> </span><span style="color:#0000FF;">null</span><span style="color:#000000;">;<br>       entity.ModifiedFromIP </span><span style="color:#000000;">=</span><span style="color:#000000;"> SecurityContext.GetHostIP();<br>       entity.ModifiedFromHostName </span><span style="color:#000000;">=</span><span style="color:#000000;"> SecurityContext.GetHostName();<br>    }<br>}</span></pre>
&lt;!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --&gt;</div>
<h4><b>CustomDeleteEventListener.cs</b></h4>
<div class="wlWriterEditableSmartContent" id="scid:57F11A72-B0E5-49c7-9094-E3A15BD5B5E6:0d9f2bf9-3a0b-4402-832d-e0e844f30d37" style="padding-right:0px;display:inline;padding-left:0px;float:none;padding-bottom:0px;margin:0px;padding-top:0px;">
<pre style="background-color:#FFFFFF;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;white-space:pre-wrap;word-wrap:break-word;overflow:auto;"><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">class</span><span style="color:#000000;"> CustomDeleteEventListener : DefaultDeleteEventListener<br>{<br>    </span><span style="color:#0000FF;">protected</span><span style="color:#000000;"> </span><span style="color:#0000FF;">override</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> DeleteEntity(IEventSource session, </span><span style="color:#0000FF;">object</span><span style="color:#000000;"> entity,<br>                        NHibernate.Engine.EntityEntry entityEntry,<br>                        </span><span style="color:#0000FF;">bool</span><span style="color:#000000;"> isCascadeDeleteEnabled,<br>                        NHibernate.Persister.Entity.IEntityPersister persister,<br>                        Iesi.Collections.ISet transientEntities)<br>   {<br>        var auditableEntity </span><span style="color:#000000;">=</span><span style="color:#000000;"> entity </span><span style="color:#0000FF;">as</span><span style="color:#000000;"> AuditableEntity;<br><br>           </span><span style="color:#0000FF;">if</span><span style="color:#000000;"> (auditableEntity </span><span style="color:#000000;">!=</span><span style="color:#000000;"> </span><span style="color:#0000FF;">null</span><span style="color:#000000;">){<br>              ProcessEntityForLogicalDelete(auditableEntity);<br>               </span><span style="color:#0000FF;">this</span><span style="color:#000000;">.CascadeBeforeDelete(session, persister, entity,<br>                   entityEntry, transientEntities);<br>               </span><span style="color:#0000FF;">this</span><span style="color:#000000;">.CascadeAfterDelete(session, persister, entity,<br>                   transientEntities);<br>       } </span><span style="color:#0000FF;">else</span><span style="color:#000000;"> {<br>            </span><span style="color:#008000;">//</span><span style="color:#008000;">normal delete</span><span style="color:#008000;"><br></span><span style="color:#000000;">               </span><span style="color:#0000FF;">base</span><span style="color:#000000;">.DeleteEntity(session, entity, entityEntry,<br>                isCascadeDeleteEnabled, persister, transientEntities);<br>       }<br>   }<br><br>   </span><span style="color:#0000FF;">private</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> ProcessEntityForLogicalDelete(AuditableEntity entity)<br>   {<br>        entity.ErasedDate </span><span style="color:#000000;">=</span><span style="color:#000000;"> DateTime.Now;<br>        entity.ErasedBy </span><span style="color:#000000;">=</span><span style="color:#000000;"> SecurityContext.LoggedUser </span><span style="color:#000000;">??</span><span style="color:#000000;"> </span><span style="color:#0000FF;">null</span><span style="color:#000000;">;<br>        entity.ErasedFromIP </span><span style="color:#000000;">=</span><span style="color:#000000;"> SecurityContext.GetHostIP();<br>        entity.ErasedFromHostName </span><span style="color:#000000;">=</span><span style="color:#000000;"> SecurityContext.GetHostName();<br>   }<br>}</span></pre>
&lt;!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --&gt;</div>
<h4><b>SecurityContext.cs</b></h4>
<div class="wlWriterEditableSmartContent" id="scid:57F11A72-B0E5-49c7-9094-E3A15BD5B5E6:64c46d35-180d-4eea-b740-092564076a3d" style="padding-right:0px;display:inline;padding-left:0px;float:none;padding-bottom:0px;margin:0px;padding-top:0px;">
<pre style="background-color:#FFFFFF;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;white-space:pre-wrap;word-wrap:break-word;overflow:auto;"><span style="color:#808080;">///</span><span style="color:#008000;"> </span><span style="color:#808080;">&lt;summary&gt;</span><span style="color:#008000;"><br></span><span style="color:#808080;">///</span><span style="color:#008000;"> Ridiculous simple crosscut security class to get user credentials and audit metadata<br></span><span style="color:#808080;">///</span><span style="color:#008000;"> </span><span style="color:#808080;">&lt;/summary&gt;</span><span style="color:#808080;"><br></span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">static</span><span style="color:#000000;"> </span><span style="color:#0000FF;">class</span><span style="color:#000000;"> SecurityContext<br>{<br>    </span><span style="color:#008000;">//</span><span style="color:#008000;">maybe System.Security.Principal.WindowsIdentity.GetCurrent().Name.ToString(), you decide</span><span style="color:#008000;"><br></span><span style="color:#000000;">    </span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">static</span><span style="color:#000000;"> User LoggedUser {</span><span style="color:#0000FF;">get</span><span style="color:#000000;">; </span><span style="color:#0000FF;">set</span><span style="color:#000000;">;}<br><br>    </span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">static</span><span style="color:#000000;"> </span><span style="color:#0000FF;">string</span><span style="color:#000000;"> GetHostName()<br>    {<br>        </span><span style="color:#0000FF;">return</span><span style="color:#000000;"> Dns.GetHostName();<br>    }<br><br>   </span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">static</span><span style="color:#000000;"> </span><span style="color:#0000FF;">string</span><span style="color:#000000;"> GetHostIP()<br>   {<br>        IPAddress[] addresses </span><span style="color:#000000;">=</span><span style="color:#000000;"> Dns.GetHostAddresses(Dns.GetHostName());<br>        <br>        </span><span style="color:#008000;">//</span><span style="color:#008000;">be carefull and filter the public ip, use the local one<br>        </span><span style="color:#008000;">//</span><span style="color:#008000;">and of course, this has no sense for an httpcontext, use remote host ip instead</span><span style="color:#008000;"><br></span><span style="color:#000000;">        </span><span style="color:#0000FF;">if</span><span style="color:#000000;"> (addresses.Length </span><span style="color:#000000;">&gt;</span><span style="color:#000000;"> </span><span style="color:#800080;">0</span><span style="color:#000000;">)<br>            </span><span style="color:#0000FF;">return</span><span style="color:#000000;"> addresses[</span><span style="color:#800080;">0</span><span style="color:#000000;">].ToString();<br>        </span><span style="color:#0000FF;">else</span><span style="color:#000000;"><br>            </span><span style="color:#0000FF;">return</span><span style="color:#000000;"> </span><span style="color:#0000FF;">null</span><span style="color:#000000;">;<br>   }<br>}</span></pre>
&lt;!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --&gt;</div>
<p>This class is just a simple helper to get the metadata needed for auditing, in this example it holds the session of the logged user too.</p>
<div class="wlWriterEditableSmartContent" id="scid:57F11A72-B0E5-49c7-9094-E3A15BD5B5E6:a58b502c-190d-4d18-9988-4eed1524b883" style="padding-right:0px;display:inline;padding-left:0px;float:none;padding-bottom:0px;margin:0px;padding-top:0px;">
<pre style="background-color:#FFFFFF;white-space:-moz-pre-wrap;white-space:-pre-wrap;white-space:-o-pre-wrap;white-space:pre-wrap;word-wrap:break-word;overflow:auto;"><span style="color:#000000;">[TestFixture]<br></span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">class</span><span style="color:#000000;"> AuditTest<br>{<br>   </span><span style="color:#0000FF;">private</span><span style="color:#000000;"> Configuration _configuration;<br>   </span><span style="color:#0000FF;">private</span><span style="color:#000000;"> ISessionFactory _sessionFactory;<br><br>   </span><span style="color:#0000FF;">private</span><span style="color:#000000;"> User _sampleUser1;<br>   </span><span style="color:#0000FF;">private</span><span style="color:#000000;"> User _sampleUser2;<br><br>   [TestFixtureSetUp]<br>   </span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> TestFixtureSetUp()<br>   {<br>       XmlConfigurator.Configure();<br><br>       _configuration </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#0000FF;">new</span><span style="color:#000000;"> Configuration();<br>       _configuration.Configure();<br>       _sessionFactory </span><span style="color:#000000;">=</span><span style="color:#000000;"> _configuration.BuildSessionFactory();<br><br>       </span><span style="color:#008000;">//</span><span style="color:#008000;">drop all tables on database</span><span style="color:#008000;"><br></span><span style="color:#000000;">       _sessionFactory.OpenSession().CreateSQLQuery(<br>               </span><span style="color:#800000;">"</span><span style="color:#800000;">IF OBJECT_ID (N'dbo.cars', N'U') IS NOT NULL DELETE cars</span><span style="color:#800000;">"</span><span style="color:#000000;"><br>        ).ExecuteUpdate();<br>       <br>       _sessionFactory.OpenSession().CreateSQLQuery(<br>               </span><span style="color:#800000;">"</span><span style="color:#800000;">IF OBJECT_ID (N'dbo.users', N'U') IS NOT NULL DELETE users</span><span style="color:#800000;">"</span><span style="color:#000000;"><br>        ).ExecuteUpdate();<br>       <br>       _sessionFactory.OpenSession().CreateSQLQuery(<br>               </span><span style="color:#800000;">"</span><span style="color:#800000;">EXEC sp_MSforeachtable ?</span><span style="color:#800000;">"</span><span style="color:#000000;"><br>        ).SetParameter(</span><span style="color:#800080;">0</span><span style="color:#000000;">,</span><span style="color:#800000;">"</span><span style="color:#800000;">DROP TABLE ?</span><span style="color:#800000;">"</span><span style="color:#000000;">).ExecuteUpdate();<br><br>       </span><span style="color:#0000FF;">new</span><span style="color:#000000;"> SchemaExport(_configuration).Create(</span><span style="color:#0000FF;">false</span><span style="color:#000000;">, </span><span style="color:#0000FF;">true</span><span style="color:#000000;">);<br><br>       PrepareLoggedUsers();<br>   }<br><br>   [TestFixtureTearDown]<br>   </span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> TestFixtureTearDown()<br>   {<br>       </span><span style="color:#008000;">//</span><span style="color:#008000;">new SchemaExport(_configuration).Drop(false, true);</span><span style="color:#008000;"><br></span><span style="color:#000000;">       _sessionFactory.Close();<br>   }<br><br>   [SetUp]<br>   </span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> TestSetUp()<br>   {<br>       _sessionFactory.OpenSession().CreateQuery(</span><span style="color:#800000;">"</span><span style="color:#800000;">delete Car</span><span style="color:#800000;">"</span><span style="color:#000000;">).ExecuteUpdate();<br>   }<br><br>   </span><span style="color:#0000FF;">private</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> PrepareLoggedUsers()<br>   {<br>       _sampleUser1 </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#0000FF;">new</span><span style="color:#000000;"> User() { Login </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">"</span><span style="color:#800000;">rcarlomagno</span><span style="color:#800000;">"</span><span style="color:#000000;">, Name </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">"</span><span style="color:#800000;">Raul</span><span style="color:#800000;">"</span><span style="color:#000000;">,<br>               LastName </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">"</span><span style="color:#800000;">Carlomagno</span><span style="color:#800000;">"</span><span style="color:#000000;">, Password </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">"</span><span style="color:#800000;">jijiji</span><span style="color:#800000;">"</span><span style="color:#000000;"> };<br>       _sampleUser2 </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#0000FF;">new</span><span style="color:#000000;"> User() { Login </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">"</span><span style="color:#800000;">ndaponte</span><span style="color:#800000;">"</span><span style="color:#000000;">, Name </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">"</span><span style="color:#800000;">Nadia</span><span style="color:#800000;">"</span><span style="color:#000000;">,<br>               LastName </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">"</span><span style="color:#800000;">Daponte</span><span style="color:#800000;">"</span><span style="color:#000000;">, Password </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">"</span><span style="color:#800000;">jujujuju</span><span style="color:#800000;">"</span><span style="color:#000000;"> };<br><br>       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ISession session </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession())<br>       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ITransaction transaction </span><span style="color:#000000;">=</span><span style="color:#000000;"> session.BeginTransaction())<br>       {<br>           session.Save(_sampleUser1);<br>           session.Save(_sampleUser2);<br>           transaction.Commit();<br>       }<br><br>       SecurityContext.LoggedUser </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sampleUser1;<br>   }<br><br>   [Test]<br>   </span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> CanAuditAddedEntity()<br>   {<br>       Car car </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#0000FF;">new</span><span style="color:#000000;"> Car() { BrandName </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">"</span><span style="color:#800000;">Renault</span><span style="color:#800000;">"</span><span style="color:#000000;">, ModelName </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">"</span><span style="color:#800000;">Clio</span><span style="color:#800000;">"</span><span style="color:#000000;">,<br>               Kilometers </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800080;">110000</span><span style="color:#000000;"> };<br>       </span><span style="color:#0000FF;">long</span><span style="color:#000000;"> carId;<br><br>       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ISession session </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession())<br>       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ITransaction transaction </span><span style="color:#000000;">=</span><span style="color:#000000;"> session.BeginTransaction())<br>       {<br>           session.SaveOrUpdate(car);<br>           transaction.Commit();<br>           carId </span><span style="color:#000000;">=</span><span style="color:#000000;"> car.Id;<br>       }<br><br>       car </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession().Get</span><span style="color:#000000;">&lt;</span><span style="color:#000000;">Car</span><span style="color:#000000;">&gt;</span><span style="color:#000000;">(carId);<br><br>       Assert.IsNotNull(car);<br>       Assert.IsNotNull(car.AddedDate);<br>       Assert.IsNotNull(car.AddedBy);<br>       Assert.IsFalse(</span><span style="color:#0000FF;">string</span><span style="color:#000000;">.IsNullOrEmpty(car.AddedFromHostName));<br>       Assert.IsFalse(</span><span style="color:#0000FF;">string</span><span style="color:#000000;">.IsNullOrEmpty(car.AddedFromIP));<br>   }<br><br>   [Test]<br>   </span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> CanAuditModifiedEntity()<br>   {<br>       </span><span style="color:#0000FF;">long</span><span style="color:#000000;"> carId;<br>       </span><span style="color:#0000FF;">const</span><span style="color:#000000;"> </span><span style="color:#0000FF;">string</span><span style="color:#000000;"> brandName </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">"</span><span style="color:#800000;">Ford</span><span style="color:#800000;">"</span><span style="color:#000000;">;<br>       </span><span style="color:#0000FF;">const</span><span style="color:#000000;"> </span><span style="color:#0000FF;">string</span><span style="color:#000000;"> modelName </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">"</span><span style="color:#800000;">Ka</span><span style="color:#800000;">"</span><span style="color:#000000;">;<br>       </span><span style="color:#0000FF;">const</span><span style="color:#000000;"> </span><span style="color:#0000FF;">long</span><span style="color:#000000;"> kilometers </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800080;">97544</span><span style="color:#000000;">;<br><br>       Car car </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#0000FF;">new</span><span style="color:#000000;"> Car() { BrandName </span><span style="color:#000000;">=</span><span style="color:#000000;"> brandName, ModelName </span><span style="color:#000000;">=</span><span style="color:#000000;"> modelName,<br>               Kilometers </span><span style="color:#000000;">=</span><span style="color:#000000;"> kilometers };<br><br>       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ISession session </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession())<br>       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ITransaction transaction </span><span style="color:#000000;">=</span><span style="color:#000000;"> session.BeginTransaction())<br>       {<br>           session.SaveOrUpdate(car);<br>           transaction.Commit();<br>           carId </span><span style="color:#000000;">=</span><span style="color:#000000;"> car.Id;<br>       }<br><br>       car </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession().Get</span><span style="color:#000000;">&lt;</span><span style="color:#000000;">Car</span><span style="color:#000000;">&gt;</span><span style="color:#000000;">(carId);<br><br>       Assert.IsNotNull(car);<br>       Assert.IsNotNull(car.AddedDate);<br>       Assert.IsNotNull(car.AddedBy);<br><br><br>       </span><span style="color:#008000;">//</span><span style="color:#008000;">let's change logged user and wait 2 seconds to change the car's data</span><span style="color:#008000;"><br></span><span style="color:#000000;">       SecurityContext.LoggedUser </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sampleUser2;<br>       Thread.Sleep(</span><span style="color:#800080;">2000</span><span style="color:#000000;">);<br><br>       car.Kilometers </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800080;">54000</span><span style="color:#000000;">;<br>       car.ModelName </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">"</span><span style="color:#800000;">Fiesta</span><span style="color:#800000;">"</span><span style="color:#000000;">;<br><br>       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ISession session </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession())<br>       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ITransaction transaction </span><span style="color:#000000;">=</span><span style="color:#000000;"> session.BeginTransaction())<br>       {<br>           session.SaveOrUpdate(car);<br>           transaction.Commit();<br>       }<br><br>       car </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession().Get</span><span style="color:#000000;">&lt;</span><span style="color:#000000;">Car</span><span style="color:#000000;">&gt;</span><span style="color:#000000;">(carId);<br><br>       Assert.IsNotNull(car);<br>       Assert.IsNotNull(car.ModifiedBy);<br>       Assert.IsNotNull(car.ModifiedDate);<br>       Assert.AreNotEqual(car.ModifiedDate, car.AddedDate);<br>       Assert.AreNotEqual(car.ModifiedBy, car.AddedBy);<br>       Assert.AreNotEqual(car.Kilometers, kilometers);<br>       Assert.AreNotEqual(car.ModelName, modelName);<br>       Assert.IsFalse(</span><span style="color:#0000FF;">string</span><span style="color:#000000;">.IsNullOrEmpty(car.ModifiedFromHostName));<br>       Assert.IsFalse(</span><span style="color:#0000FF;">string</span><span style="color:#000000;">.IsNullOrEmpty(car.ModifiedFromIP));<br>   }<br><br>   [Test]<br>   </span><span style="color:#0000FF;">public</span><span style="color:#000000;"> </span><span style="color:#0000FF;">void</span><span style="color:#000000;"> CanAuditErasedEntity()<br>   {<br>       </span><span style="color:#0000FF;">const</span><span style="color:#000000;"> </span><span style="color:#0000FF;">string</span><span style="color:#000000;"> brandName </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">"</span><span style="color:#800000;">Citroen</span><span style="color:#800000;">"</span><span style="color:#000000;">;<br>       </span><span style="color:#0000FF;">const</span><span style="color:#000000;"> </span><span style="color:#0000FF;">string</span><span style="color:#000000;"> modelName </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800000;">"</span><span style="color:#800000;">C3</span><span style="color:#800000;">"</span><span style="color:#000000;">;<br>       </span><span style="color:#0000FF;">const</span><span style="color:#000000;"> </span><span style="color:#0000FF;">long</span><span style="color:#000000;"> kilometers </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#800080;">74665</span><span style="color:#000000;">;<br>       </span><span style="color:#0000FF;">long</span><span style="color:#000000;"> carId;<br><br>       Car car </span><span style="color:#000000;">=</span><span style="color:#000000;"> </span><span style="color:#0000FF;">new</span><span style="color:#000000;"> Car() { BrandName </span><span style="color:#000000;">=</span><span style="color:#000000;"> brandName, ModelName </span><span style="color:#000000;">=</span><span style="color:#000000;"> modelName,<br>               Kilometers </span><span style="color:#000000;">=</span><span style="color:#000000;"> kilometers };<br><br>       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ISession session </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession())<br>       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ITransaction transaction </span><span style="color:#000000;">=</span><span style="color:#000000;"> session.BeginTransaction())<br>       {<br>           session.SaveOrUpdate(car);<br>           transaction.Commit();<br>           carId </span><span style="color:#000000;">=</span><span style="color:#000000;"> car.Id;<br>       }<br><br>       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ISession session </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession())<br>       </span><span style="color:#0000FF;">using</span><span style="color:#000000;"> (ITransaction transaction </span><span style="color:#000000;">=</span><span style="color:#000000;"> session.BeginTransaction())<br>       {<br>           session.Delete(car);<br>           transaction.Commit();<br>       }<br><br>       car </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession().Get</span><span style="color:#000000;">&lt;</span><span style="color:#000000;">Car</span><span style="color:#000000;">&gt;</span><span style="color:#000000;">(carId);<br><br>       Assert.IsNotNull(car);<br>       Assert.IsNotNull(car.ErasedBy);<br>       Assert.IsNotNull(car.ErasedDate);<br>       Assert.IsFalse(</span><span style="color:#0000FF;">string</span><span style="color:#000000;">.IsNullOrEmpty(car.ErasedFromHostName));<br>       Assert.IsFalse(</span><span style="color:#0000FF;">string</span><span style="color:#000000;">.IsNullOrEmpty(car.ErasedFromIP));<br><br>       ISession tmpSession </span><span style="color:#000000;">=</span><span style="color:#000000;"> _sessionFactory.OpenSession();<br>       tmpSession.EnableFilter(</span><span style="color:#800000;">"</span><span style="color:#800000;">avoidLogicalDeleted</span><span style="color:#800000;">"</span><span style="color:#000000;">);<br>       Assert.AreEqual(</span><span style="color:#800080;">0</span><span style="color:#000000;">, tmpSession.CreateCriteria</span><span style="color:#000000;">&lt;</span><span style="color:#000000;">Car</span><span style="color:#000000;">&gt;</span><span style="color:#000000;">().List().Count);<br>       tmpSession.DisableFilter(</span><span style="color:#800000;">"</span><span style="color:#800000;">avoidLogicalDeleted</span><span style="color:#800000;">"</span><span style="color:#000000;">);<br>       Assert.AreEqual(</span><span style="color:#800080;">1</span><span style="color:#000000;">, tmpSession.CreateCriteria</span><span style="color:#000000;">&lt;</span><span style="color:#000000;">Car</span><span style="color:#000000;">&gt;</span><span style="color:#000000;">().List().Count);<br><br>   }<br>}</span></pre>
&lt;!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --&gt;</div>
<p>This test fixture proves that i am not lying. :-)</p>
<p>A few last words, in CanAuditErasedEntity() method, at the end of it, it is supposed that if we deleted logically an entity, we don’t want to see it in the results, so before doing a Criteria or HQL to get some data, we must enable the filter on the ISession, because filters are disabled by default. I do not know if there is a way to enable it on the ISessionFactory, to avoid manually enable it each time we want to get some data.</p>
<p>Well, this is the first time i write an article, i hope the next will be better. Sorry for my english.</p>
<p><a href="http://www.2shared.com/file/6380003/67d562c8/AuditExample.html">Solution Download</a></p>
</div>
            </div>
        
        
    </div>
</div>





</div></div>
			    <div style="clear: both;"></div>
			    
			    
            </div>

