---
layout: post
title: "Ohâ€¦ beautiful SQL"
date: 2009-05-08 13:39:00 +1200
comments: true
published: true
categories: ["blogs", "nhibernate", "archive"]
tags: ["News", "NHibernate", "HQL"]
redirect_from: ["/blogs/nhibernate/archive/2009/05/08/oh-beautiful-sql.aspx/", "/blogs/nhibernate/archive/2009/05/08/oh-beautiful-sql.html"]
author: fabiomaulo
gravatar: cd6db202ce94ed7e5f1fde30e702dc7f
---
{% include imported_disclaimer.html %}
<p>[<a href="http://fabiomaulo.blogspot.com/" target="_blank">My Blog</a>]</p>
<p>Given a complex mapping like this</p>
<pre class="code"><span style="color:blue;">&lt;</span><span style="color:#a31515;">class </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">Animal</span>"<span style="color:blue;">&gt;<br />  &lt;</span><span style="color:#a31515;">id </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">id</span>"<span style="color:blue;">&gt;<br />      &lt;</span><span style="color:#a31515;">generator </span><span style="color:red;">class</span><span style="color:blue;">=</span>"<span style="color:blue;">native</span>"<span style="color:blue;">/&gt;<br />  &lt;/</span><span style="color:#a31515;">id</span><span style="color:blue;">&gt;<br />  &lt;</span><span style="color:#a31515;">property </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">description</span>"<span style="color:blue;">/&gt;<br />  &lt;</span><span style="color:#a31515;">property </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">bodyWeight</span>" <span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">body_weight</span>"<span style="color:blue;">/&gt;<br />  &lt;</span><span style="color:#a31515;">many-to-one </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">mother</span>" <span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">mother_id</span>"<span style="color:blue;">/&gt;<br />  &lt;</span><span style="color:#a31515;">many-to-one </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">father</span>" <span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">father_id</span>"<span style="color:blue;">/&gt;<br />  &lt;</span><span style="color:#a31515;">many-to-one </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">zoo</span>" <span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">zoo_id</span>"<span style="color:blue;">/&gt;<br />  &lt;</span><span style="color:#a31515;">property </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">serialNumber</span>"<span style="color:blue;">/&gt;<br />  &lt;</span><span style="color:#a31515;">set </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">offspring</span>" <span style="color:red;">order-by</span><span style="color:blue;">=</span>"<span style="color:blue;">father_id</span>"<span style="color:blue;">&gt;<br />      &lt;</span><span style="color:#a31515;">key </span><span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">mother_id</span>"<span style="color:blue;">/&gt;<br />      &lt;</span><span style="color:#a31515;">one-to-many </span><span style="color:red;">class</span><span style="color:blue;">=</span>"<span style="color:blue;">Animal</span>"<span style="color:blue;">/&gt;<br />  &lt;/</span><span style="color:#a31515;">set</span><span style="color:blue;">&gt;<br />  &lt;</span><span style="color:#a31515;">joined-subclass </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">Reptile</span>"<span style="color:blue;">&gt;<br />      &lt;</span><span style="color:#a31515;">key </span><span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">animal</span>"<span style="color:blue;">/&gt;<br />      &lt;</span><span style="color:#a31515;">property </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">bodyTemperature</span>"<span style="color:blue;">/&gt;<br />      &lt;</span><span style="color:#a31515;">joined-subclass </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">Lizard</span>"<span style="color:blue;">&gt;<br />          &lt;</span><span style="color:#a31515;">key </span><span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">reptile</span>"<span style="color:blue;">/&gt;<br />      &lt;/</span><span style="color:#a31515;">joined-subclass</span><span style="color:blue;">&gt;<br />  &lt;/</span><span style="color:#a31515;">joined-subclass</span><span style="color:blue;">&gt;<br />  &lt;</span><span style="color:#a31515;">joined-subclass </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">Mammal</span>"<span style="color:blue;">&gt;<br />      &lt;</span><span style="color:#a31515;">key </span><span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">animal</span>"<span style="color:blue;">/&gt;<br />      &lt;</span><span style="color:#a31515;">property </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">pregnant</span>"<span style="color:blue;">/&gt;<br />      &lt;</span><span style="color:#a31515;">property </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">birthdate</span>" <span style="color:red;">type</span><span style="color:blue;">=</span>"<span style="color:blue;">date</span>"<span style="color:blue;">/&gt;<br />      &lt;</span><span style="color:#a31515;">joined-subclass </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">DomesticAnimal</span>"<span style="color:blue;">&gt;<br />          &lt;</span><span style="color:#a31515;">key </span><span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">mammal</span>"<span style="color:blue;">/&gt;<br />          &lt;</span><span style="color:#a31515;">many-to-one </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">owner</span>"<span style="color:blue;">/&gt;<br />          &lt;</span><span style="color:#a31515;">joined-subclass </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">Cat</span>"<span style="color:blue;">&gt;<br />              &lt;</span><span style="color:#a31515;">key </span><span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">mammal</span>"<span style="color:blue;">/&gt;<br />          &lt;/</span><span style="color:#a31515;">joined-subclass</span><span style="color:blue;">&gt;<br />          &lt;</span><span style="color:#a31515;">joined-subclass </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">Dog</span>"<span style="color:blue;">&gt;<br />              &lt;</span><span style="color:#a31515;">key </span><span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">mammal</span>"<span style="color:blue;">/&gt;<br />          &lt;/</span><span style="color:#a31515;">joined-subclass</span><span style="color:blue;">&gt;<br />      &lt;/</span><span style="color:#a31515;">joined-subclass</span><span style="color:blue;">&gt;<br />      &lt;</span><span style="color:#a31515;">joined-subclass </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">Human</span>"<span style="color:blue;">&gt;<br />          &lt;</span><span style="color:#a31515;">key </span><span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">mammal</span>"<span style="color:blue;">/&gt;<br />          &lt;</span><span style="color:#a31515;">component </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">name</span>"<span style="color:blue;">&gt;<br />              &lt;</span><span style="color:#a31515;">property </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">first</span>" <span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">name_first</span>"<span style="color:blue;">/&gt;<br />              &lt;</span><span style="color:#a31515;">property </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">initial</span>" <span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">name_initial</span>"<span style="color:blue;">/&gt;<br />              &lt;</span><span style="color:#a31515;">property </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">last</span>" <span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">name_last</span>"<span style="color:blue;">/&gt;<br />          &lt;/</span><span style="color:#a31515;">component</span><span style="color:blue;">&gt;<br />          &lt;</span><span style="color:#a31515;">property </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">nickName</span>"<span style="color:blue;">/&gt;<br />          &lt;</span><span style="color:#a31515;">property </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">height</span>"<span style="color:blue;">/&gt;<br /><br />          &lt;</span><span style="color:#a31515;">property </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">intValue</span>"<span style="color:blue;">/&gt;<br />          &lt;</span><span style="color:#a31515;">property </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">floatValue</span>"<span style="color:blue;">/&gt;<br />          &lt;</span><span style="color:#a31515;">property </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">bigDecimalValue</span>"<span style="color:blue;">/&gt;<br />          &lt;</span><span style="color:#a31515;">property </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">bigIntegerValue</span>"<span style="color:blue;">/&gt;<br /><br />          &lt;</span><span style="color:#a31515;">bag </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">friends</span>"<span style="color:blue;">&gt;<br />              &lt;</span><span style="color:#a31515;">key </span><span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">human1</span>"<span style="color:blue;">/&gt;<br />              &lt;</span><span style="color:#a31515;">many-to-many </span><span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">human2</span>" <span style="color:red;">class</span><span style="color:blue;">=</span>"<span style="color:blue;">Human</span>"<span style="color:blue;">/&gt;<br />          &lt;/</span><span style="color:#a31515;">bag</span><span style="color:blue;">&gt;<br />          &lt;</span><span style="color:#a31515;">map </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">family</span>"<span style="color:blue;">&gt;<br />              &lt;</span><span style="color:#a31515;">key </span><span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">human1</span>"<span style="color:blue;">/&gt;<br />              &lt;</span><span style="color:#a31515;">map-key </span><span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">relationship</span>" <span style="color:red;">type</span><span style="color:blue;">=</span>"<span style="color:blue;">string</span>"<span style="color:blue;">/&gt;<br />              &lt;</span><span style="color:#a31515;">many-to-many </span><span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">human2</span>" <span style="color:red;">class</span><span style="color:blue;">=</span>"<span style="color:blue;">Human</span>"<span style="color:blue;">/&gt;<br />          &lt;/</span><span style="color:#a31515;">map</span><span style="color:blue;">&gt;<br />          &lt;</span><span style="color:#a31515;">bag </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">pets</span>" <span style="color:red;">inverse</span><span style="color:blue;">=</span>"<span style="color:blue;">true</span>"<span style="color:blue;">&gt;<br />              &lt;</span><span style="color:#a31515;">key </span><span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">owner</span>"<span style="color:blue;">/&gt;<br />              &lt;</span><span style="color:#a31515;">one-to-many </span><span style="color:red;">class</span><span style="color:blue;">=</span>"<span style="color:blue;">DomesticAnimal</span>"<span style="color:blue;">/&gt;<br />          &lt;/</span><span style="color:#a31515;">bag</span><span style="color:blue;">&gt;<br />          &lt;</span><span style="color:#a31515;">set </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">nickNames</span>" <span style="color:red;">lazy</span><span style="color:blue;">=</span>"<span style="color:blue;">false</span>" <span style="color:red;">table</span><span style="color:blue;">=</span>"<span style="color:blue;">human_nick_names</span>" <span style="color:red;">sort</span><span style="color:blue;">=</span>"<span style="color:blue;">natural</span>"<span style="color:blue;">&gt;<br />              &lt;</span><span style="color:#a31515;">key </span><span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">human</span>"<span style="color:blue;">/&gt;<br />              &lt;</span><span style="color:#a31515;">element </span><span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">nick_name</span>" <span style="color:red;">type</span><span style="color:blue;">=</span>"<span style="color:blue;">string</span>" <span style="color:red;">not-null</span><span style="color:blue;">=</span>"<span style="color:blue;">true</span>"<span style="color:blue;">/&gt;<br />          &lt;/</span><span style="color:#a31515;">set</span><span style="color:blue;">&gt;<br />          &lt;</span><span style="color:#a31515;">map </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">addresses</span>" <span style="color:red;">table</span><span style="color:blue;">=</span>"<span style="color:blue;">addresses</span>"<span style="color:blue;">&gt;<br />              &lt;</span><span style="color:#a31515;">key </span><span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">human</span>"<span style="color:blue;">/&gt;<br />              &lt;</span><span style="color:#a31515;">map-key </span><span style="color:red;">type</span><span style="color:blue;">=</span>"<span style="color:blue;">string</span>" <span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">type</span>"<span style="color:blue;">/&gt;<br />              &lt;</span><span style="color:#a31515;">composite-element </span><span style="color:red;">class</span><span style="color:blue;">=</span>"<span style="color:blue;">Address</span>"<span style="color:blue;">&gt;<br />                  &lt;</span><span style="color:#a31515;">property </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">street</span>"<span style="color:blue;">/&gt;<br />                  &lt;</span><span style="color:#a31515;">property </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">city</span>"<span style="color:blue;">/&gt;<br />                  &lt;</span><span style="color:#a31515;">property </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">postalCode</span>"<span style="color:blue;">/&gt;<br />                  &lt;</span><span style="color:#a31515;">property </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">country</span>"<span style="color:blue;">/&gt;<br />                  &lt;</span><span style="color:#a31515;">many-to-one </span><span style="color:red;">name</span><span style="color:blue;">=</span>"<span style="color:blue;">stateProvince</span>" <span style="color:red;">column</span><span style="color:blue;">=</span>"<span style="color:blue;">state_prov_id</span>" <span style="color:red;">class</span><span style="color:blue;">=</span>"<span style="color:blue;">StateProvince</span>"<span style="color:blue;">/&gt;<br />              &lt;/</span><span style="color:#a31515;">composite-element</span><span style="color:blue;">&gt;<br />          &lt;/</span><span style="color:#a31515;">map</span><span style="color:blue;">&gt;<br />      &lt;/</span><span style="color:#a31515;">joined-subclass</span><span style="color:blue;">&gt;<br />  &lt;/</span><span style="color:#a31515;">joined-subclass</span><span style="color:blue;">&gt;<br />&lt;/</span><span style="color:#a31515;">class</span><span style="color:blue;">&gt;</span></pre>
<p>Which should be the result of&nbsp;s.CreateQuery(<span style="color:#800000;">"delete Animal"</span>).ExecuteUpdate() ?</p>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>Oh&hellip; beautiful SQL</p>
<p>create table #Animal (id BIGINT not null)&nbsp;</p>
<p>insert into #Animal SELECT animal0_.id as id FROM Animal animal0_</p>
<p>DELETE FROM Human WHERE (mammal) IN (select id from #Animal)<br /><br />DELETE FROM Dog WHERE (mammal) IN (select id from #Animal)<br /><br />DELETE FROM Cat WHERE (mammal) IN (select id from #Animal)<br /><br />DELETE FROM DomesticAnimal WHERE (mammal) IN (select id from #Animal)<br /><br />DELETE FROM Mammal WHERE (animal) IN (select id from #Animal)<br /><br />DELETE FROM Lizard WHERE (reptile) IN (select id from #Animal)<br /><br />DELETE FROM Reptile WHERE (animal) IN (select id from #Animal)<br /><br />DELETE FROM Animal WHERE (id) IN (select id from #Animal)<br /><br />drop table #Animal</p>
<p>Do you see the temp table ? Do you see the order of queries ?</p>
<p><strong>&ldquo;se me cay&oacute; una lagrima&rdquo;</strong></p>
